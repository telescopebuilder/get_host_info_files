---
- hosts:
  - ubuntu-test-srv-1
  - ubuntu-test-srv-2
  - ubuntu-test-srv-3
  tasks:
    - name: Fetch the file from remote node to buffer
      fetch:
        src: /tmp/{{ inventory_hostname }}_inventory_information.txt
        dest: /tmp/awx-host-info/
        flat: yes

    - name: Ensure /tmp/combined-host-info is a file, not a directory
      delegate_to: andy-awxnode-test
      become: yes
      become_user: root
      shell: "if [ -d /tmp/combined-host-info ]; then rm -r /tmp/combined-host-info; fi; touch /tmp/combined-host-info"

    - name: Concatenate the files into one file
      delegate_to: andy-awxnode-test
      become: yes
      become_user: root
      shell: "cat /tmp/awx-host-info/*.txt >> /tmp/combined-host-info"
      register: cat_result

    - name: Ensure newline between concatenated files
      delegate_to: andy-awxnode-test
      become: yes
      become_user: root
      shell: "echo >> /tmp/combined-host-info"
      when: cat_result.rc == 0
